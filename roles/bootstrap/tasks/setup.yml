---
# tasks file for bootstrap

- name: Create swapfile
  shell: |
    truncate -s 0 {{ bootstrap_root_dir }}/.swap/swapfile
    chattr +C {{ bootstrap_root_dir }}/.swap/swapfile
    if [ "$(findmnt -no FSTYPE -T {{ bootstrap_root_dir }}/.swap)" == "btrfs" ]; then
        btrfs property set {{ bootstrap_root_dir }}/.swap/swapfile compression none
    fi
    fallocate -l 4G {{ bootstrap_root_dir }}/.swap/swapfile
    chmod 600 {{ bootstrap_root_dir }}/.swap/swapfile
    mkswap {{ bootstrap_root_dir }}/.swap/swapfile
    swapon {{ bootstrap_root_dir }}/.swap/swapfile
    echo "/.swap/swapfile none swap defaults 0 0" >> {{ bootstrap_root_dir }}/etc/fstab
    echo "vm.swappiness=10" >> {{ bootstrap_root_dir }}/etc/sysctl.conf
    systemctl daemon-reload
  args:
    creates: "{{ bootstrap_root_dir }}/.swap/swapfile"
  register: output
- debug:
    msg: "{{ output.stdout_lines }}"

- name: Create keys
  shell: |
    dd if=/dev/random of={{ bootstrap_root_dir }}/.keys/cryptbtrfs.keyfile iflag=fullblock bs=512 count=8
    chmod 000 {{ bootstrap_root_dir }}/.keys/cryptbtrfs.keyfile
    if [ "{{ ansible_pkg_mgr }}" == "dnf" ]; then
        echo 'install_items+="/.keys/cryptbtrfs.keyfile"' >> {{ bootstrap_root_dir }}/etc/dracut.conf
        sed -i 's/none/\/.keys\/cryptbtrfs.keyfile/g' {{ bootstrap_root_dir }}/etc/crypttab
        dracut --force
    fi
  args:
    creates: "{{ bootstrap_root_dir }}/.keys/cryptbtrfs.keyfile"
  register: output
- debug:
    msg: "{{ output.stdout_lines }}"

- name: Configure snapper
  shell: |
    snapper --config=root create-config /
    snapper --config=root create --description="Initial"
    snapper --config=home create-config /home
    snapper --config=home create --description="Initial"
  args:
    creates: "{{ bootstrap_root_dir }}/etc/snapper/configs/root"
  register: output
- debug:
    msg: "{{ output.stdout_lines }}"

- name: Change shell to zsh
  command: "chsh -s /bin/zsh {{ bootstrap_user }}"
  register: output
- debug:
    msg: "{{ output.stdout_lines }}"

- name: Generate public/private rsa key pair
  become: yes
  become_user: "{{ bootstrap_user }}"
  shell: |
    . {{ bootstrap_user_dir }}/.zshrc
    mkdir -p {{ bootstrap_user_dir }}/.ssh
    ssh-keygen -t rsa -b 4096 -N "" -f {{ bootstrap_user_dir }}/.ssh/id_rsa
  args:
    executable: /usr/bin/zsh
    creates: "{{ bootstrap_user_dir }}/.ssh/id_rsa"
  register: output
- debug:
    msg: "{{ output.stdout_lines }}"

- name: Install latest Node LTS version
  become: yes
  become_user: "{{ bootstrap_user }}"
  shell: |
    . {{ bootstrap_user_dir }}/.zshrc
    nvm install --lts --latest-npm
  args:
    executable: /usr/bin/zsh
  register: output
- debug:
    msg: "{{ output.stdout_lines }}"

- name: Install latest Python packages
  become: yes
  become_user: "{{ bootstrap_user }}"
  shell: |
    . {{ bootstrap_user_dir }}/.zshrc
    pip install --upgrade --user pipenv black cmake-format
  args:
    executable: /usr/bin/zsh
  register: output
- debug:
    msg: "{{ output.stdout_lines }}"

- name: Install latest Rust toolchain
  become: yes
  become_user: "{{ bootstrap_user }}"
  shell: |
    . {{ bootstrap_user_dir }}/.zshrc
    curl --proto '=https' --tlsv1.2 -sSf https://sh.rustup.rs | sh -s -- --no-modify-path -y
    rustup component add rls rust-analysis rust-src
    rustup update
    cargo install cargo-tree cargo-edit wasm-pack || true
    mkdir -p {{ bootstrap_user_dir }}/.config/rustfmt
    rustfmt --print-config default {{ bootstrap_user_dir }}/.config/rustfmt/rustfmt.toml
  args:
    executable: /usr/bin/zsh
    warn: no
  register: output
- debug:
    msg: "{{ output.stdout_lines }}"

- name: Install latest Elm version
  become: yes
  become_user: "{{ bootstrap_user }}"
  # shell: |
  #   curl -L -o {{ bootstrap_temp_dir }}/elm.gz https://github.com/elm/compiler/releases/download/0.19.1/binary-for-linux-64-bit.gz
  #   gunzip {{ bootstrap_temp_dir }}/elm.gz
  #   chmod +x {{ bootstrap_temp_dir }}/elm
  #   mv {{ bootstrap_temp_dir }}/elm /usr/local/bin
  shell: |
    . {{ bootstrap_user_dir }}/.zshrc
    npm install -g elm elm-format elm-test @elm-tooling/elm-language-server
    npm update -g
  args:
    executable: /usr/bin/zsh
    warn: no
  register: output
- debug:
    msg: "{{ output.stdout_lines }}"

# - name: Install latest Haskell toolchain
#   become: yes
#   become_user: "{{ bootstrap_user }}"
#   shell: |
#     . {{ bootstrap_user_dir }}/.zshrc
#     stack upgrade
#     stack install ghcid
#     stack ./install.hs hie
#   args:
#     chdir: "{{ bootstrap_user_dir }}/.haskell-ide-engine"
#     executable: /usr/bin/zsh
#     warn: no
#   register: output
# - debug:
#     msg: "{{ output.stdout_lines }}"
